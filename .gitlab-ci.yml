variables:
  BUILD_ENV: "pd-build-mgmt-373"
  RUNNING_ENV: "pd-ci-mgmt-373"
  PYTHON_PATH: "/D/Projects/PD/softwares/python/python-3.7.3"
  BASE_PYTHON_PATH: "D:/Projects/PD/softwares/python/python-3.7.3"
  VE_PATH: "${CI_BUILDS_DIR}/${RUNNING_ENV}/Scripts/activate.ps1"
  NSSM_PATH: "/D/Projects/PD/softwares/nssm/nssm-2.24/win64/nssm.exe"
  SERVICE_NAME: "pd-ci-mgmt"
  PACKAGE: "pd-mgmt"
#   GIT_CLONE_PATH: "${CI_BUILDS_DIR}/${PACKAGE}"
#   CI_DEBUG_TRACE: "false"


stages:
  - test
  - sonar-scan
  - build
  - deploy
  - build-test
  - deploy-test
  - build_svt
  - deploy_svt
  - build_uat
  - deploy_uat
  - build_prod
  - deploy_prod

default:
  before_script:
    - sh etmfa/ci_scripts/create_venv.sh
    - . $VE_PATH

flake8:
  tags:
    - pd-dev-windows-ml01q
  stage: test
  script:
    - flake8 --exit-zero --max-line-length=120
  allow_failure: true # Remove it, when ready
  only:
    refs:
      - develop
      - merge_requests
    variables: 
      - $ENVIRONMENT== "dev"

unit-tests:
  tags:
      - pd-dev-windows-ml01q
  stage: test
  before_script:
    - . $VE_PATH
  script:
    - python -m pytest -v --junit-xml=test_results.xml --cov=etmfa --cov-report=xml
  artifacts:
      paths:
      - test_results.xml
      - coverage.xml
  only:
    refs:
      - develop
      - merge_requests
    variables: 
      - $ENVIRONMENT== "dev"

Perform Sonarqube Analysis and quality gate:  
  image: sonarsource/sonar-scanner-cli
  stage: sonar-scan
  before_script:
    - echo "Setting up for Sonarqube Analysis on $CI_COMMIT_REF_NAME branch"
    - apk upgrade --update-cache --available && apk add openssl
    - openssl s_client -connect   usadc-vspsq01.quintiles.net:443 | keytool -import -noprompt -alias sonarqbue_test -keystore $JAVA_HOME/lib/security/cacerts -storepass changeit
  script:
    - echo "Running Sonarqube Analysis on $CI_COMMIT_REF_NAME branch"
    - apk upgrade --update-cache --available && apk add openssl
    - sh scripts/sonarqube.sh branch > /tmp/sonar.log
    - cat /tmp/sonar.log
    - echo "Running Sonarqube quality gate on $CI_COMMIT_REF_NAME branch"
    - sh scripts/qualitygate.sh
  allow_failure: true    
  tags:
    - ca2ugitla006p-D4
  only:
    refs:
      - develop
      - merge_requests
    variables: 
      - $ENVIRONMENT== "dev"       

build:
  tags:
    - pd-dev-windows-ml01q
  stage: build
  before_script:
    - . $VE_PATH  
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - develop
      - merge_requests
    variables: 
      - $ENVIRONMENT== "dev"

deploy-dev:
  tags:
    - pd-dev-windows-ml01q
  stage: deploy
  variables:
    VERIFICATION_URL: "http://ca2spdml01q:9001/pd/api/health"
  script:
    - sh etmfa/ci_scripts/deploy.sh dist
  environment:
    name: dev
  only:
    refs:
      - develop
    variables: 
      - $ENVIRONMENT== "dev"
      
build-test:
  tags:
    - pd-test-windows-ml101q
  stage: build-test
  before_script:
    - . $VE_PATH  
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - develop
      - pd-release/1.3_qc
      - merge_requests
    variables: 
      - $ENVIRONMENT== "test"

deploy-test:
  tags:
    - pd-test-windows-ml101q
  stage: deploy-test
  variables:
    VERIFICATION_URL: "http://ca2spdml101q:9001/pd/api/health"
  script:
    - sh etmfa/ci_scripts/deploy.sh dist
  environment:
    name: test
  only:
    refs:
      - develop
      - pd-release/1.3_qc
    variables:
      - $ENVIRONMENT== "test"
  

build-svt:
  tags:
    - ca2spdml15q
  stage: build_svt
  before_script:
    - . $VE_PATH  
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - feature/cicd-changes-svt
      - develop
      - master
      - pd-release/1.3_qc
      - merge_requests
    variables: 
      - $ENVIRONMENT== "svt"

deploy-svt:
  tags:
    - ca2spdml15q
  stage: deploy_svt
  variables:
    VERIFICATION_URL: "http://ca2spdml15q:9001/pd/api/health"
  script:
    - sh etmfa/ci_scripts/deploy.sh dist
  environment:
    name: svt
  only:
    refs:
      - feature/cicd-changes-svt
      - develop
      - master
      - pd-release/1.3_qc
      
    variables: 
      - $ENVIRONMENT== "svt"

build-uat:
  tags:
    - ca2spdml05c
  stage: build_uat
  before_script:
    - . $VE_PATH  
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - feature/cicd-changes-svt
      - master
      - pd-release/1.3_qc
      - merge_requests
    variables: 
      - $ENVIRONMENT== "uat"

deploy-uat:
  tags:
    - ca2spdml05c
  stage: deploy_uat
  variables:
    VERIFICATION_URL: "http://ca2spdml05c:9001/pd/api/health"
  script:
    - sh etmfa/ci_scripts/deploy.sh dist
  environment:
    name: uat
  only:
    refs:
      - feature/cicd-changes-svt
      - master
      - pd-release/1.3_qc
    variables: 
      - $ENVIRONMENT== "uat"

build-prod:
  tags:
    - ca2spdml05p
  stage: build_prod
  before_script:
    - . $VE_PATH    
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist/
  only:
    refs:
      - master
      - pd-release/1.3
    variables: 
      - $ENVIRONMENT== "prod"

deploy-prod:
  tags:
    - ca2spdml05p
  stage: deploy_prod
  variables:
    VERIFICATION_URL: "http://ca2spdml05p:9001/pd/api/health"
  script:
    - sh etmfa/ci_scripts/deploy.sh dist
  environment:
    name: prod
  only:
    refs:
      - master
      - pd-release/1.3
    variables: 
      - $ENVIRONMENT== "prod"